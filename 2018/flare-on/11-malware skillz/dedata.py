# -*- coding:utf-8 -*-
import pyaes
import zlib
import pyshark

def decodecaptcp():
  key1 = '62421C37A8B11C501D47EEEC0F5F05B2'.decode('hex')
  key2 = '126965b0159f7316d47c6ab74cb27fb6'.decode('hex')
#  cap = pyshark.FileCapture('pcap_tcp.pcap',display_filter="tcp")
  cap = pyshark.FileCapture('pcap.pcap')
  s = ''
  try:
    with open('all.bin','ab') as fp:
      for pkt in cap:
        di = ''
        idx = 0
        if int(pkt.length) >66 and 'data' in pkt.__dir__():
          if pkt.ip.src == '192.168.221.91':
            di = 'T'
          else:
            di = 'R'
          idx = int(pkt.number)
          data = pkt.data.data.decode('hex')
          if len(data) > 58 and data[3] == '\x8f' and idx!=3382 and idx!=3390 and idx!=3393:
            if 'smb2' in pkt.__dir__():
              key = key2
            else:
              key = key1
            iv = data[42:58]
            c = data[58:]
            m = de(c,key,iv)
            fp.write('index:{:d} action:{} data_hex:{} data_ori:{}'.format(idx,di,m.encode('hex'),m))
            fp.write('\r\n')
          print idx
  except:
    print idx
    pass
    
def de(c,key,iv):   
   aes = pyaes.AESModeOfOperationCFB(key, iv = iv, segment_size = 16)
   m = aes.decrypt(c)
   return zlib.decompress(m)
   
def main():
  decodecaptcp()
  print 'end.'

if __name__ == '__main__':
  main()